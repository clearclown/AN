# AN システムアーキテクチャ

## 概要

ANは5層のレイヤードアーキテクチャを採用しています。

## レイヤー構成

```
┌─────────────────────────────────────────────────────────────┐
│                       CLI Layer                              │
│                  (clap derive macros)                        │
│         引数パース、サブコマンドルーティング                    │
├─────────────────────────────────────────────────────────────┤
│                     Command Layer                            │
│          install │ remove │ link │ update                    │
│              ビジネスロジック、フロー制御                       │
├─────────────────────────────────────────────────────────────┤
│                     Handler Layer                            │
│           deb │ appimage │ flatpak │ remote                  │
│        各パッケージ形式の処理実装                              │
├─────────────────────────────────────────────────────────────┤
│                       DB Layer                               │
│                 TOML App Database                            │
│         アプリ情報の読み込み・検索・管理                        │
├─────────────────────────────────────────────────────────────┤
│                      Utils Layer                             │
│              fs │ ui │ config │ network                      │
│          共通ユーティリティ、ヘルパー関数                       │
└─────────────────────────────────────────────────────────────┘
```

## 各レイヤーの責務

### 1. CLI Layer (`src/cli.rs`)

- コマンドライン引数のパース
- サブコマンドの定義と振り分け
- ヘルプメッセージの生成
- グローバルオプションの処理

**依存関係:** clap (derive)

### 2. Command Layer (`src/commands/`)

- 各コマンドのビジネスロジック
- Handler層の呼び出し
- エラーハンドリングと結果出力
- ユーザー確認プロンプト

**モジュール:**
- `install.rs` - インストール処理
- `remove.rs` - 削除処理
- `link.rs` - エイリアス生成
- `update.rs` - アップデート処理

### 3. Handler Layer (`src/handlers/`)

- パッケージ形式ごとの処理実装
- システムコマンドの実行
- ファイル操作の実行

**モジュール:**
- `deb.rs` - .deb パッケージ処理 (dpkg, apt)
- `appimage.rs` - AppImage処理 (移動、権限、シンボリックリンク)
- `flatpak.rs` - Flatpak処理 (flatpak コマンド)
- `remote.rs` - リモートダウンロード処理

### 4. DB Layer (`src/db/`)

- TOMLファイルの読み込み・パース
- アプリ情報の検索
- データ構造の定義

**モジュール:**
- `app.rs` - App構造体、Source構造体の定義

### 5. Utils Layer (`src/utils/`)

- ファイルシステム操作
- UI出力 (カラー、プログレス)
- 設定ファイル管理
- ネットワーク操作

**モジュール:**
- `fs.rs` - ファイル操作ユーティリティ
- `ui.rs` - カラー出力、プログレスバー
- `config.rs` - 設定管理 (将来)
- `network.rs` - ダウンロード処理 (将来)

## データフロー

```
User Input
    │
    ▼
┌─────────┐    parse     ┌──────────┐
│   CLI   │ ──────────── │ Command  │
└─────────┘              └────┬─────┘
                              │
                ┌─────────────┼─────────────┐
                │             │             │
                ▼             ▼             ▼
          ┌─────────┐  ┌─────────┐   ┌─────────┐
          │ Handler │  │ Handler │   │   DB    │
          │  (deb)  │  │(appimage)│  │ (toml)  │
          └────┬────┘  └────┬────┘   └────┬────┘
               │            │             │
               ▼            ▼             ▼
          ┌─────────────────────────────────────┐
          │              Utils                   │
          │    (fs, ui, config, network)         │
          └─────────────────────────────────────┘
                              │
                              ▼
                      System / Output
```

## ディレクトリ構造

```
src/
├── main.rs              # エントリーポイント
├── lib.rs               # ライブラリエントリ
├── cli.rs               # CLI Layer
├── errors.rs            # エラー型定義
├── commands/
│   ├── mod.rs
│   ├── install.rs
│   ├── remove.rs
│   ├── link.rs
│   └── update.rs
├── handlers/
│   ├── mod.rs
│   ├── deb.rs
│   ├── appimage.rs
│   ├── flatpak.rs
│   └── remote.rs
├── db/
│   ├── mod.rs
│   └── app.rs
└── utils/
    ├── mod.rs
    ├── fs.rs
    └── ui.rs
```

## 設計原則

1. **関心の分離**: 各レイヤーは明確な責務を持つ
2. **依存関係の方向**: 上位レイヤーが下位レイヤーに依存
3. **テスタビリティ**: 各レイヤーは独立してテスト可能
4. **エラー伝播**: `anyhow::Result` によるエラー伝播
